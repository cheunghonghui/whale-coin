import{j as C,b as A,s as R,k as M,l as P}from"./api-B2IVDk6a.js";import{a as l,E as B}from"./index-Bg3u_l3A.js";import{m as E,a as i,Z as N,d as g,ah as b,p as n,q as d,t as y,M as w,O as m,S as f,R as v,U as r,T as V,u as x}from"./vue-DRvwLzXx.js";import"./base-BDaasHXh.js";import"./index-kI_rcZ0B.js";import"./crypto-BjADBdty.js";const j={class:"flex flex-col items-center justify-center space-y-2 p-4"},T={class:"flex flex-row items-center justify-center space-x-4"},D={key:0,class:"text-green-500 mt-2"},F={key:1,class:"text-red-500 mt-2"},q={key:2,class:"text-gray-500 mt-2"},O=y("br",null,null,-1),Z=y("h2",{class:"text-center"},"全部鲸币申请",-1),Q=E({__name:"FetchRepo",setup($){const u=i(null);document.title="数据更新";let _=N([]);const p=async()=>{var t;try{const s=await A();_.splice(0,_.length,...s)}catch(s){const e=s;l.error("数据获取失败: "+(((t=e.response)==null?void 0:t.message)||e.message))}};g(p);const c=i(!1),h=i(!1),o=i("");g(()=>{k()});const k=async()=>{var t;try{const s=await C(),e=s==null?void 0:s.is_running;c.value=e,e?l.success("任务正在运行"):l.info("任务没有运行")}catch(s){const e=s;l.error("无法检查定时任务状态: "+(((t=e.response)==null?void 0:t.message)||e.message)),c.value=!1}},S=async()=>{var t;try{l.success("定时更新任务已启动"),c.value=!0;const s=await R();if(s.status==="success"){const e=s.message;o.value=e;let a=0;u.value=setInterval(async()=>{a++,await p(),console.log(`更新次数: ${a}`)},1*60*60*1e3)}else l.error("定时更新任务 数据拉取错误: "+s.message)}catch(s){const e=s;l.error("启动定时更新任务失败: "+(((t=e.response)==null?void 0:t.message)||e.message))}};setInterval(p,1*60*1e3+15e3);const U=async()=>{var t;try{await M(),u.value&&(clearInterval(u.value),u.value=null),l.success("定时更新任务已停止"),c.value=!1}catch(s){const e=s;l.error("停止定时更新任务失败: "+(((t=e.response)==null?void 0:t.message)||e.message))}},I=async()=>{var t;try{h.value=!0,o.value="正在一次性更新数据...";const s=await P(),e=s.message;o.value=e,s.status==="success"?(await p(),l.success("本次手动更新完成")):l.success("更新未成功")}catch(s){const e=s;l.error("手动更新任务失败: "+(((t=e.response)==null?void 0:t.message)||e.message)),o.value="手动更新任务失败"}finally{h.value=!1}};return(t,s)=>{const e=b("el-button"),a=b("el-table-column");return n(),d("div",j,[y("div",T,[c.value?v("",!0):(n(),w(e,{key:0,type:"success",onClick:S,class:"w-48"},{default:m(()=>[f(" 开始定时拉取 ")]),_:1})),c.value?(n(),w(e,{key:1,type:"danger",onClick:U,class:"w-48"},{default:m(()=>[f(" 停止定时拉取 ")]),_:1})):v("",!0),r(e,{type:"primary",disabled:h.value,onClick:I,class:"w-48"},{default:m(()=>[f(" 手动拉取 ")]),_:1},8,["disabled"])]),c.value?(n(),d("p",D," 定时任务正在运行 ")):(n(),d("p",F,"定时任务未运行")),o.value?(n(),d("p",q,V(o.value),1)):v("",!0),O,Z,r(x(B),{data:x(_),stripe:"","highlight-current-row":"",style:{width:"100%"}},{default:m(()=>[r(a,{prop:"user_name",label:"申请人"}),r(a,{prop:"repo",label:"仓库",width:"80"}),r(a,{prop:"role",label:"角色"}),r(a,{prop:"content",label:"内容"}),r(a,{prop:"amount",label:"数额"}),r(a,{prop:"record_time",label:"产生时间"}),r(a,{prop:"apply_status",label:"申请状态"}),r(a,{prop:"apply_time",label:"申请时间"}),r(a,{prop:"decision",label:"审批决定"})]),_:1},8,["data"])])}}});export{Q as default};
